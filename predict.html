<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Dá»± Ä‘oÃ¡n cáº£m xÃºc khuÃ´n máº·t</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 30px; background: #f9fafc; }
    img, video { max-width: 320px; margin: 10px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    button { margin: 5px; padding: 10px 15px; border: none; background: #0078ff; color: white; border-radius: 6px; cursor: pointer; }
    button:hover { background: #005bcc; }
    #result { font-size: 20px; margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>ğŸ­ Dá»± Ä‘oÃ¡n cáº£m xÃºc khuÃ´n máº·t</h2>

  <input type="file" id="file" accept="image/*"><br>
  <video id="video" autoplay playsinline width="320" height="240"></video><br>
  <button id="start">ğŸ“· Báº­t Camera</button>
  <button id="snap">ğŸ“¸ Chá»¥p áº£nh</button>

  <canvas id="canvas" width="48" height="48" style="display:none;"></canvas>
  <h3 id="result">â³ Äang táº£i model...</h3>

  <script>
    const labels = ["Angry","Disgust","Fear","Happy","Sad","Surprise","Neutral"];
    let model;

    // âš¡ï¸ Load model â€” Æ°u tiÃªn cache (IndexedDB)
    async function loadModel() {
      document.getElementById("result").innerText = "â³ Äang táº£i model...";
      try {
        model = await tf.loadLayersModel("indexeddb://emotion-model");
        document.getElementById("result").innerText = "âœ… Model táº£i tá»« cache!";
        console.log("Loaded from IndexedDB");
      } catch {
        model = await tf.loadLayersModel("model.json");
        await model.save("indexeddb://emotion-model");
        document.getElementById("result").innerText = "âœ… Model táº£i tá»« file vÃ  Ä‘Ã£ lÆ°u cache!";
        console.log("Loaded from file & saved to IndexedDB");
      }
    }

    async function predictImage(imgEl) {
      const tensor = tf.browser.fromPixels(imgEl, 1)
        .resizeNearestNeighbor([48,48])
        .toFloat()
        .div(255.0)
        .expandDims(0);
      const prediction = model.predict(tensor);
      const data = await prediction.data();
      const maxIndex = data.indexOf(Math.max(...data));
      document.getElementById("result").innerText = `Cáº£m xÃºc: ${labels[maxIndex]} ğŸ˜ƒ`;
    }

    document.getElementById("file").onchange = e => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => predictImage(img);
      img.src = URL.createObjectURL(file);
    };

    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    document.getElementById("start").onclick = async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        if (!model) await loadModel();
      } catch (err) {
        alert("KhÃ´ng thá»ƒ truy cáº­p camera: " + err.message);
      }
    };

    document.getElementById("snap").onclick = () => {
      ctx.drawImage(video, 0, 0, 48, 48);
      predictImage(canvas);
    };

    loadModel();
  </script>
</body>
</html>